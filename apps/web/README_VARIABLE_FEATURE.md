# 变量功能使用说明

## 📝 功能概述

动作流程输入框现在支持变量语法，可以在输入中使用 `${变量名}` 格式定义变量。系统会自动在不同场景下进行不同的转换：

- **UI 编辑时**：显示原始的 `${变量名}` 语法，带有淡蓝色背景和加粗样式高亮
- **发送后端时**：自动去掉 `${}` 符号，只保留变量名
- **JSON 预览/复制时**：替换为统一的占位符 `lbxx`

## 🎯 使用场景

### 示例 1：搜索功能
```
输入：点击搜索结果中最符合${测试搜索词}的内容（优先点击字符完全匹配的）

发送后端：点击搜索结果中最符合测试搜索词的内容（优先点击字符完全匹配的）

JSON 预览：点击搜索结果中最符合lbxx的内容（优先点击字符完全匹配的）
```

### 示例 2：表单填写
```
输入：在邮箱输入框中输入${用户邮箱}

发送后端：在邮箱输入框中输入用户邮箱

JSON 预览：在邮箱输入框中输入lbxx
```

## 💡 变量语法规则

### 基本语法
```
${变量名}
```

### 语法特点
- ✅ 支持中文变量名
- ✅ 支持英文变量名
- ✅ 支持数字和下划线
- ✅ 可以在文本的任意位置使用
- ✅ 一个输入框可以包含多个变量

### 示例
```
✅ 正确：点击${按钮名称}按钮
✅ 正确：输入${username}和${password}
✅ 正确：${操作类型}搜索结果
✅ 正确：等待${目标元素_001}出现

❌ 错误：$变量名（缺少花括号）
❌ 错误：{变量名}（缺少 $ 符号）
❌ 错误：${变量{嵌套}}（不支持嵌套）
```

## 🎨 视觉效果

### 输入框中的变量高亮
变量会以以下样式显示：
- **淡蓝色背景**（浅色模式：`#dbeafe`，深色模式：`rgba(30, 58, 138, 0.3)`）
- **加粗字体**
- **圆角边框**（4px）
- **内边距**（2px 4px）

示例：
```
点击搜索结果中最符合 ${测试搜索词} 的内容
                    ^^^^^^^^^^^^^^^^
                    淡蓝色背景 + 加粗
```

## 🔧 技术实现

### 核心组件

#### 1. `useVariableTransform` Hook
```typescript
const { toRuntime, toPlaceholder, transformTasks } = useVariableTransform();

// 转换为运行时值
toRuntime("点击${按钮}") // → "点击按钮"

// 转换为占位符
toPlaceholder("点击${按钮}") // → "点击lbxx"

// 转换整个任务列表
transformTasks(tasks, 'runtime') // 或 'placeholder'
```

#### 2. `VariableInput` 组件
纯手工实现的单行输入框，完美支持中文输入法，自动高亮变量。

**技术特点**：
- ✅ 使用原生 `<input>` 元素，完全支持中文输入法（IME）
- ✅ 双层叠加技术：底层显示高亮，顶层透明输入
- ✅ 实时同步滚动位置
- ✅ HTML 内容转义，防止 XSS 攻击

```tsx
<VariableInput
  value={value}
  onChange={(newValue) => setValue(newValue)}
  placeholder="例如：点击${按钮名称}"
/>
```

#### 3. `VariableTextarea` 组件
纯手工实现的多行文本框，完美支持中文输入法，自动高亮变量。

**技术特点**：
- ✅ 使用原生 `<textarea>` 元素，完全支持中文输入法（IME）
- ✅ 双层叠加技术：底层显示高亮，顶层透明输入
- ✅ 实时同步垂直和水平滚动
- ✅ 支持多行文本和自动换行
- ✅ HTML 内容转义，防止 XSS 攻击

```tsx
<VariableTextarea
  value={value}
  onChange={(newValue) => setValue(newValue)}
  placeholder="输入多行描述..."
  rows={3}
/>
```

### 实现原理

#### 双层叠加技术
```
┌─────────────────────────────┐
│ 容器 (relative)              │
│  ┌─────────────────────────┐│
│  │ 高亮层 (absolute, z-0)  ││ ← 显示带样式的文本
│  │ ${变量} 淡蓝色背景      ││
│  └─────────────────────────┘│
│  ┌─────────────────────────┐│
│  │ 输入层 (relative, z-10) ││ ← 原生 input/textarea
│  │ 透明文字，可见光标      ││
│  └─────────────────────────┘│
└─────────────────────────────┘
```

#### 中文输入法支持
- 🟢 **原生元素**：使用标准 HTML `<input>` 和 `<textarea>`
- 🟢 **IME 事件**：浏览器自动处理 compositionstart/compositionend
- 🟢 **无干扰**：高亮层完全不可交互，不影响输入法

### 自动转换流程

```
┌─────────────────────────────────────────┐
│ 用户在输入框输入: "点击${搜索词}"       │
└─────────────────┬───────────────────────┘
                  │
                  ├─→ 存储到 Store (保持原样)
                  │
                  │
      ┌───────────┴───────────┐
      │                       │
      ▼                       ▼
┌──────────┐          ┌──────────────┐
│ 点击执行 │          │ 查看JSON预览 │
└────┬─────┘          └──────┬───────┘
     │                       │
     │ useVariableTransform  │ useVariableTransform
     │ .toRuntime()          │ .toPlaceholder()
     │                       │
     ▼                       ▼
"点击搜索词"           "点击lbxx"
     │                       │
     ▼                       ▼
  发送后端               显示/复制
```

## 📂 文件清单

### 新增文件
- `apps/web/src/hooks/useVariableTransform.ts` - 变量转换逻辑
- `apps/web/src/components/ui/variable-input.tsx` - 变量输入框组件
- `apps/web/src/components/ui/variable-textarea.tsx` - 变量文本框组件

### 修改文件
- `apps/web/src/components/debug/FlowActionItem.tsx` - 集成变量输入组件
- `apps/web/src/components/debug/JsonPreview.tsx` - JSON 预览使用占位符
- `apps/web/src/pages/midsceneDebugPage.tsx` - 发送时转换为运行时值

## 🚀 快速开始

### 1. ~~安装依赖~~（已改为纯手工实现，无需安装额外依赖）
~~```bash
pnpm add react-mentions
```~~

**注意**：由于 `react-mentions` 对中文输入法支持不佳，已改为纯原生实现，无需安装任何第三方库！

### 2. 使用变量输入框
在任何需要支持变量的输入字段中，系统已自动替换为 `VariableInput` 或 `VariableTextarea`。

### 3. 输入变量
直接在输入框中输入 `${` 就会自动识别为变量的开始，输入 `}` 结束变量定义。

### 4. 查看效果
- **编辑时**：变量会高亮显示
- **JSON 预览**：变量会替换为 `lbxx`
- **执行时**：变量会自动去掉 `${}`

## 🔍 支持变量的字段

所有字符串类型的动作参数都支持变量，包括但不限于：

### 基础操作
- `aiTap.locate` - 点击位置描述
- `aiInput.value` - 输入内容
- `aiInput.locate` - 输入框位置
- `aiAssert.assertion` - 断言描述
- `aiAssert.errorMessage` - 错误信息

### 鼠标操作
- `aiHover.locate` - 悬停位置
- `aiDoubleClick.locate` - 双击位置
- `aiRightClick.locate` - 右键位置

### 等待与查询
- `aiWaitFor.assertion` - 等待条件
- `aiQuery.demand` - 查询需求
- `aiQuery.name` - 查询结果名称

### AI 操作
- `aiString.prompt` - 字符串查询
- `aiNumber.prompt` - 数字查询
- `aiBoolean.prompt` - 布尔值查询
- `aiAction.prompt` - 任务描述
- `aiLocate.prompt` - 元素描述

### 其他
- `logText.text` - 日志文本
- `setClipboard.text` - 剪贴板内容
- `javascript.code` - JavaScript 代码
- `activateWindow.windowHandle` - 窗口句柄

## 💡 最佳实践

### 1. 语义化的变量名
```
✅ 好：${用户名} ${邮箱地址} ${搜索关键词}
❌ 差：${var1} ${temp} ${x}
```

### 2. 保持一致性
在同一个流程中，相同含义的变量使用相同的名称。

### 3. 避免过长的变量名
```
✅ 好：${目标按钮}
❌ 差：${需要点击的那个位于页面右上角的确认按钮}
```

### 4. 注释说明
在模板描述中说明变量的用途和预期值。

## ⚠️ 注意事项

1. **占位符固定为 `lbxx`**：所有变量在 JSON 预览中都会显示为同一个占位符，这是设计行为。

2. **历史记录保留原始值**：历史记录中保存的是包含变量语法的原始值，方便复用。

3. **模板中的变量**：保存为模板时会保留变量语法，加载模板后可以继续使用。

4. **不支持变量嵌套**：`${{nested}}` 这样的语法不被支持。

5. **JSON 编辑模式**：在 JSON 编辑模式下直接修改参数时，变量语法会被保留，但不会高亮显示。

## 🐛 常见问题

### Q: 为什么 JSON 预览中都显示为 `lbxx`？
A: 这是设计行为。JSON 预览的目的是提供一个统一的占位符，方便复制和分享模板结构，而不暴露具体的变量名。

### Q: 变量在发送后端时会保留 `${}` 吗？
A: 不会。系统会自动去掉 `${}` 符号，只保留变量名发送给后端。

### Q: 可以在一个输入框中使用多个变量吗？
A: 可以！例如：`点击${类型}中的${名称}按钮`

### Q: 变量名可以包含空格吗？
A: 可以，但不推荐。建议使用下划线或驼峰命名法。

### Q: 如何输入字面量的 `${}`？
A: 目前不支持转义，如果需要输入字面量 `${}`，建议使用其他表述方式。

## 📊 性能说明

- ✅ 变量转换在内存中进行，性能开销极小
- ✅ 使用 `useMemo` 缓存转换结果，避免重复计算
- ✅ 纯原生实现，零依赖，体积更小
- ✅ 使用正则表达式高效匹配变量
- ✅ 不影响原有表单的保存和加载性能
- ✅ 完美支持中文输入法，无卡顿

## 🎉 总结

变量功能让动作流程更加灵活和可复用。通过简单的 `${变量名}` 语法，你可以：
- ✅ 创建可重用的任务模板
- ✅ 提高脚本的可读性和可维护性
- ✅ 在不同环境下快速调整参数
- ✅ 分享通用的自动化流程模板

开始使用变量，让你的自动化脚本更加智能！🚀

