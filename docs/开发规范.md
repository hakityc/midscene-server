# Midscene Server é¡¹ç›®å¼€å‘è§„èŒƒ

> **ç‰ˆæœ¬**: v1.0.0
> **æ›´æ–°æ—¥æœŸ**: 2025å¹´10æœˆ24æ—¥
> **é€‚ç”¨èŒƒå›´**: midscene-server Monorepo

---

## ğŸ“‹ ç›®å½•

- [1. ä»£ç é£æ ¼ä¸æ ¼å¼åŒ–](#1-ä»£ç é£æ ¼ä¸æ ¼å¼åŒ–)
- [2. å‘½åè§„èŒƒ](#2-å‘½åè§„èŒƒ)
- [3. æ¶æ„ä¸è®¾è®¡æ¨¡å¼](#3-æ¶æ„ä¸è®¾è®¡æ¨¡å¼)
- [4. ç±»å‹å®šä¹‰è§„èŒƒ](#4-ç±»å‹å®šä¹‰è§„èŒƒ)
- [5. é”™è¯¯å¤„ç†è§„èŒƒ](#5-é”™è¯¯å¤„ç†è§„èŒƒ)
- [6. æ—¥å¿—è§„èŒƒ](#6-æ—¥å¿—è§„èŒƒ)
- [7. WebSocket é€šä¿¡è§„èŒƒ](#7-websocket-é€šä¿¡è§„èŒƒ)
- [8. æµ‹è¯•è§„èŒƒ](#8-æµ‹è¯•è§„èŒƒ)
- [9. æ–‡æ¡£è§„èŒƒ](#9-æ–‡æ¡£è§„èŒƒ)
- [10. Git æäº¤è§„èŒƒ](#10-git-æäº¤è§„èŒƒ)
- [11. æœåŠ¡å±‚å¼€å‘è§„èŒƒ](#11-æœåŠ¡å±‚å¼€å‘è§„èŒƒ)
- [12. æ–‡ä»¶ç»„ç»‡è§„èŒƒ](#12-æ–‡ä»¶ç»„ç»‡è§„èŒƒ)
- [13. æ€§èƒ½ä¼˜åŒ–è§„èŒƒ](#13-æ€§èƒ½ä¼˜åŒ–è§„èŒƒ)
- [14. å®‰å…¨è§„èŒƒ](#14-å®‰å…¨è§„èŒƒ)

---

## 1. ä»£ç é£æ ¼ä¸æ ¼å¼åŒ–

### 1.1 åŸºæœ¬è§„åˆ™

é¡¹ç›®ä½¿ç”¨ **Biome** è¿›è¡Œä»£ç æ ¼å¼åŒ–å’Œ lintï¼Œé…ç½®æ–‡ä»¶ï¼š`biome.json`

```javascript
// æ ¸å¿ƒé…ç½®
{
  "formatter": {
    "lineWidth": 80,
    "indentStyle": "space",
    "indentWidth": 2,
    "lineEnding": "lf"
  },
  "javascript": {
    "formatter": {
      "quoteStyle": "single"
    }
  }
}
```

### 1.2 å¼ºåˆ¶è§„åˆ™

- âœ… **ä½¿ç”¨å•å¼•å·** (`'`) ä»£æ›¿åŒå¼•å·
- âœ… **ç¼©è¿›**: 2 ä¸ªç©ºæ ¼
- âœ… **è¡Œå®½**: æœ€å¤§ 80 å­—ç¬¦
- âœ… **æ¢è¡Œç¬¦**: LF (Unix é£æ ¼)
- âœ… **åˆ†å·**: è‡ªåŠ¨æ·»åŠ ï¼ˆBiome å¤„ç†ï¼‰
- âœ… **å°¾éšé€—å·**: å¤šè¡Œå¯¹è±¡/æ•°ç»„æ·»åŠ 

### 1.3 ä»£ç ç»„ç»‡é¡ºåº

```typescript
// 1. Import å£°æ˜ï¼ˆæŒ‰ç±»å‹åˆ†ç»„ï¼‰
import type { SomeType } from 'external-package';
import { externalFunction } from 'external-package';
import type { InternalType } from '@/types';
import { internalFunction } from '@/utils';

// 2. ç±»å‹å®šä¹‰
export interface MyInterface {
  // ...
}

export type MyType = string | number;

// 3. å¸¸é‡å®šä¹‰
const MY_CONSTANT = 'value';

// 4. å‡½æ•°/ç±»å®šä¹‰
export class MyClass {
  // ...
}

export function myFunction() {
  // ...
}
```

### 1.4 å‘½ä»¤

```bash
# æ ¼å¼åŒ–ä»£ç 
pnpm format

# æ£€æŸ¥ä»£ç è´¨é‡
pnpm check

# è‡ªåŠ¨ä¿®å¤é—®é¢˜
pnpm fix

# Lint ä»£ç 
pnpm lint
```

---

## 2. å‘½åè§„èŒƒ

### 2.1 æ–‡ä»¶å‘½å

| ç±»å‹ | å‘½åè§„åˆ™ | ç¤ºä¾‹ |
|------|---------|------|
| æ™®é€šæ–‡ä»¶ | camelCase | `webOperateService.ts` |
| ç»„ä»¶æ–‡ä»¶ | PascalCase | `JsonPreview.tsx` |
| ç±»å‹æ–‡ä»¶ | camelCase | `websocket.ts`, `index.ts` |
| é…ç½®æ–‡ä»¶ | kebab-case | `tsup.config.ts` |
| æµ‹è¯•æ–‡ä»¶ | åŸå.test.ts | `error.test.ts` |
| å·¥å…·æ–‡ä»¶ | camelCase | `logger.ts`, `error.ts` |

### 2.2 ä»£ç å‘½å

#### å˜é‡å’Œå‡½æ•°

```typescript
// âœ… å¥½çš„å‘½å
const userName = 'John';
const isConnected = true;
const hasError = false;
const totalCount = 10;

function getUserById(id: string) { }
function calculateTotal() { }
function handleWebSocketMessage() { }

// âŒ ä¸å¥½çš„å‘½å
const user_name = 'John';  // ä¸ä½¿ç”¨ snake_case
const connected = true;    // å¸ƒå°”å€¼åº”æœ‰ is/has å‰ç¼€
const t = 10;              // å˜é‡åè¿‡çŸ­
function get(id) { }       // å‡½æ•°åä¸æ˜ç¡®
```

#### ç±»å’Œæ¥å£

```typescript
// âœ… ç±»ä½¿ç”¨ PascalCase
class BaseOperateService { }
class WebOperateServiceRefactored { }
class ClientCommandHelper { }

// âœ… æ¥å£ä½¿ç”¨ PascalCaseï¼Œä½¿ç”¨ I å‰ç¼€ï¼ˆå¯é€‰ï¼‰
interface TaskTipCallbackConfig { }
interface WebSocketMessage { }
interface IUserRepository { }  // å¯é€‰çš„ I å‰ç¼€

// âœ… æšä¸¾ä½¿ç”¨ PascalCaseï¼Œæˆå‘˜ä½¿ç”¨ UPPER_CASE
enum OperateServiceState {
  STOPPED = 'stopped',
  STARTING = 'starting',
  RUNNING = 'running',
}

enum WebSocketAction {
  EXECUTE = 'execute',
  CALLBACK_AI_STEP = 'callback_ai_step',
}
```

#### ç±»å‹åˆ«å

```typescript
// âœ… ä½¿ç”¨ PascalCase
type AgentType = AgentOverChromeBridge | AgentOverWindows;
type TaskTipCallback = (tip: string, error?: Error) => void;
type ClientType = 'web' | 'windows';
```

#### å¸¸é‡

```typescript
// âœ… å…¨å±€å¸¸é‡ä½¿ç”¨ UPPER_SNAKE_CASE
const MAX_RETRY_COUNT = 3;
const DEFAULT_TIMEOUT = 5000;
const API_BASE_URL = 'https://api.example.com';

// âœ… é…ç½®å¯¹è±¡ä½¿ç”¨ camelCase
const serverConfig = {
  port: 3000,
  host: 'localhost',
};
```

### 2.3 ç‰¹æ®Šå‘½åçº¦å®š

#### Service ç±»

```typescript
// æ ¼å¼ï¼š<Platform>OperateService[Refactored]
class WebOperateService { }
class WebOperateServiceRefactored { }
class WindowsOperateService { }
class WindowsOperateServiceRefactored { }
```

#### Handler å‡½æ•°

```typescript
// æ ¼å¼ï¼šhandle<Action>
function handleExecute() { }
function handleConnect() { }
function handleWebSocketMessage() { }
```

#### Logger å®ä¾‹

```typescript
// æ ¼å¼ï¼š<module>Logger
const wsLogger = createLogger('websocket');
const serverLogger = createLogger('server');
const serviceLogger = createLogger('service');
```

---

## 3. æ¶æ„ä¸è®¾è®¡æ¨¡å¼

### 3.1 æ ¸å¿ƒæ¶æ„

é¡¹ç›®é‡‡ç”¨ **åˆ†å±‚æ¶æ„** + **è®¾è®¡æ¨¡å¼** çš„ç»„åˆï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         WebSocket Layer             â”‚
â”‚  (handlers, builders, helpers)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          Service Layer              â”‚
â”‚  (BaseOperateService + å­ç±»)        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         Integration Layer           â”‚
â”‚  (Midscene, Mastra, MCP)            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.2 å¿…é¡»éµå¾ªçš„è®¾è®¡æ¨¡å¼

#### 3.2.1 å•ä¾‹æ¨¡å¼

æ‰€æœ‰ Service ç±»å¿…é¡»ä½¿ç”¨å•ä¾‹æ¨¡å¼ï¼š

```typescript
export class MyService {
  private static instance: MyService | null = null;

  private constructor() {
    // ç§æœ‰æ„é€ å‡½æ•°
  }

  public static getInstance(): MyService {
    if (!MyService.instance) {
      MyService.instance = new MyService();
    }
    return MyService.instance;
  }

  public static resetInstance(): void {
    MyService.instance = null;
  }
}
```

#### 3.2.2 å·¥å‚æ¨¡å¼

åˆ›å»º Handler æ—¶ä½¿ç”¨å·¥å‚å‡½æ•°ï¼š

```typescript
export function createAiHandlerFactory(
  getService: () => BaseOperateService<any>,
  serviceName: string,
  options?: HandlerOptions,
): MessageHandler {
  return async ({ connectionId, send }, message) => {
    const service = getService();
    // å¤„ç†é€»è¾‘
  };
}
```

#### 3.2.3 æ¨¡æ¿æ–¹æ³•æ¨¡å¼

Service åŸºç±»å®šä¹‰ç®—æ³•éª¨æ¶ï¼Œå­ç±»å®ç°å…·ä½“æ­¥éª¤ï¼š

```typescript
export abstract class BaseOperateService<TAgent> {
  // æ¨¡æ¿æ–¹æ³•
  public async start(): Promise<void> {
    this.setState(OperateServiceState.STARTING);
    await this.createAgent();
    await this.initializeConnection();
    this.setState(OperateServiceState.RUNNING);
  }

  // æŠ½è±¡æ–¹æ³•ï¼ˆå­ç±»å¿…é¡»å®ç°ï¼‰
  protected abstract createAgent(): Promise<void>;
  protected abstract initializeConnection(): Promise<void>;
  protected abstract getServiceName(): string;
}
```

#### 3.2.4 ç­–ç•¥æ¨¡å¼

ä¸åŒå¹³å°ä½¿ç”¨ä¸åŒçš„æ‰§è¡Œç­–ç•¥ï¼š

```typescript
// Web ç­–ç•¥
class WebOperateServiceRefactored extends BaseOperateService {
  protected async executeAiTask(params: any) {
    // Web ç‰¹å®šå®ç°
  }
}

// Windows ç­–ç•¥
class WindowsOperateServiceRefactored extends BaseOperateService {
  protected async executeAiTask(params: any) {
    // Windows ç‰¹å®šå®ç°
  }
}
```

### 3.3 ç¦æ­¢çš„æ¨¡å¼

- âŒ **ç¦æ­¢ä½¿ç”¨ God Object**ï¼šå•ä¸ªç±»ä¸åº”è¶…è¿‡ 500 è¡Œ
- âŒ **ç¦æ­¢æ·±åº¦åµŒå¥—**ï¼šå‡½æ•°åµŒå¥—ä¸è¶…è¿‡ 4 å±‚
- âŒ **ç¦æ­¢å¾ªç¯ä¾èµ–**ï¼šæ¨¡å—é—´ä¸å…è®¸å¾ªç¯å¼•ç”¨
- âŒ **ç¦æ­¢å…¨å±€çŠ¶æ€æ±¡æŸ“**ï¼šä½¿ç”¨ä¾èµ–æ³¨å…¥ä»£æ›¿å…¨å±€å˜é‡

---

## 4. ç±»å‹å®šä¹‰è§„èŒƒ

### 4.1 åŸºæœ¬åŸåˆ™

- âœ… **ä¼˜å…ˆä½¿ç”¨ `interface`**ï¼šå¯¹è±¡å½¢çŠ¶å®šä¹‰
- âœ… **ä½¿ç”¨ `type`**ï¼šè”åˆç±»å‹ã€äº¤å‰ç±»å‹ã€åŸºæœ¬ç±»å‹åˆ«å
- âœ… **é¿å… `any`**ï¼šå¿…é¡»ä½¿ç”¨æ—¶æ·»åŠ æ³¨é‡Šè¯´æ˜åŸå› 
- âœ… **ä½¿ç”¨ä¸¥æ ¼çš„ TypeScript é…ç½®**

### 4.2 ç±»å‹å®šä¹‰ä½ç½®

```
src/types/
â”œâ”€â”€ index.ts              # é€šç”¨ç±»å‹
â”œâ”€â”€ websocket.ts          # WebSocket ç›¸å…³ç±»å‹
â”œâ”€â”€ windowsProtocol.ts    # Windows åè®®ç±»å‹
â”œâ”€â”€ promptOptimization.ts # æç¤ºä¼˜åŒ–ç±»å‹
â””â”€â”€ cls.ts                # æ—¥å¿—ä¸Šä¸‹æ–‡ç±»å‹
```

### 4.3 ç±»å‹å®šä¹‰ç¤ºä¾‹

#### Interface å®šä¹‰

```typescript
// âœ… æ¸…æ™°çš„æ¥å£å®šä¹‰
export interface WebSocketMessage {
  meta: {
    messageId: string;
    conversationId: string;
    timestamp: number;
  };
  payload: {
    action: WebSocketAction;
    params: any;
    site: string;
  };
}

// âœ… æ³›å‹æ¥å£
export interface ApiResponse<T = any> {
  success: boolean;
  data?: T;
  message?: string;
  error?: string;
}
```

#### Type Alias

```typescript
// âœ… è”åˆç±»å‹
export type ClientType = 'web' | 'windows';
export type WsStatus = 'success' | 'failed';

// âœ… å‡½æ•°ç±»å‹
export type TaskTipCallback = (
  tip: string,
  bridgeError?: Error | null
) => void;

// âœ… å¤æ‚ç±»å‹ç»„åˆ
export type AgentType = AgentOverChromeBridge | AgentOverWindows;
```

#### æ³›å‹çº¦æŸ

```typescript
// âœ… ä½¿ç”¨æ³›å‹çº¦æŸ
export abstract class BaseOperateService<TAgent extends AgentType> {
  public agent: TAgent | null = null;
}

// âœ… å‡½æ•°æ³›å‹
export function createLogger<T extends object>(
  name: string,
  meta?: T
) {
  // ...
}
```

### 4.4 é¿å…çš„æ¨¡å¼

```typescript
// âŒ è¿‡åº¦ä½¿ç”¨ any
function processData(data: any) { }

// âœ… ä½¿ç”¨å…·ä½“ç±»å‹
function processData(data: WebSocketMessage) { }

// âŒ ä¸å¿…è¦çš„ç±»å‹æ–­è¨€
const result = getData() as string;

// âœ… ä½¿ç”¨ç±»å‹å®ˆå«
function isString(value: unknown): value is string {
  return typeof value === 'string';
}

// âŒ éšå¼ any
function handleMessage(message) { }  // å‚æ•°éšå¼ä¸º any

// âœ… æ˜¾å¼ç±»å‹
function handleMessage(message: WebSocketMessage) { }
```

---

## 5. é”™è¯¯å¤„ç†è§„èŒƒ

### 5.1 è‡ªå®šä¹‰é”™è¯¯ç±»

```typescript
// âœ… ç»§æ‰¿ Error ç±»
export class AppError extends Error {
  constructor(
    public message: string,
    public statusCode: number = 500,
    public isOperational: boolean = true,
  ) {
    super(message);
    Object.setPrototypeOf(this, AppError.prototype);
  }
}

// âœ… ç‰¹å®šé¢†åŸŸé”™è¯¯
export class WebSocketError extends AppError {
  constructor(message: string, public connectionId: string) {
    super(message, 500);
  }
}
```

### 5.2 é”™è¯¯å¤„ç†æ¨¡å¼

```typescript
// âœ… Try-Catch-Finally
async function executeTask() {
  try {
    await someOperation();
  } catch (error) {
    // è®°å½•é”™è¯¯
    serviceLogger.error({ error }, 'ä»»åŠ¡æ‰§è¡Œå¤±è´¥');

    // è½¬æ¢ä¸ºåº”ç”¨é”™è¯¯
    if (error instanceof Error) {
      throw new AppError(error.message, 500);
    }

    // æœªçŸ¥é”™è¯¯
    throw new AppError('æœªçŸ¥é”™è¯¯', 500);
  } finally {
    // æ¸…ç†èµ„æº
    await cleanup();
  }
}

// âœ… é”™è¯¯ä¼ æ’­
async function highLevelFunction() {
  try {
    await executeTask();
  } catch (error) {
    // æ·»åŠ ä¸Šä¸‹æ–‡åé‡æ–°æŠ›å‡º
    if (error instanceof AppError) {
      error.message = `é«˜çº§æ“ä½œå¤±è´¥: ${error.message}`;
      throw error;
    }
    throw error;
  }
}
```

### 5.3 é”™è¯¯å“åº”

```typescript
// WebSocket é”™è¯¯å“åº”
function createErrorResponse(
  message: WebSocketMessage,
  error: Error,
  errorMessage: string,
): WsOutboundMessage {
  return {
    meta: {
      messageId: message.meta.messageId,
      conversationId: message.meta.conversationId,
      timestamp: Date.now(),
    },
    payload: {
      action: message.payload.action,
      status: 'failed',
      error: errorMessage,
    },
  };
}
```

### 5.4 é”™è¯¯æ—¥å¿—

```typescript
// âœ… è®°å½•å®Œæ•´çš„é”™è¯¯ä¿¡æ¯
serviceLogger.error(
  {
    error: error,
    stack: error.stack,
    context: {
      userId,
      taskId,
      timestamp: Date.now(),
    },
  },
  'ä»»åŠ¡æ‰§è¡Œå¤±è´¥'
);

// âŒ ä¸è¦åªè®°å½•é”™è¯¯æ¶ˆæ¯
serviceLogger.error(error.message);
```

---

## 6. æ—¥å¿—è§„èŒƒ

### 6.1 æ—¥å¿—çº§åˆ«

| çº§åˆ« | ä½¿ç”¨åœºæ™¯ | ç¤ºä¾‹ |
|------|---------|------|
| `debug` | è°ƒè¯•ä¿¡æ¯ï¼Œå¼€å‘ç¯å¢ƒ | å˜é‡å€¼ã€å‡½æ•°è°ƒç”¨ |
| `info` | ä¸€èˆ¬ä¿¡æ¯ï¼Œå…³é”®æ“ä½œ | æœåŠ¡å¯åŠ¨ã€è¿æ¥å»ºç«‹ |
| `warn` | è­¦å‘Šä¿¡æ¯ï¼Œæ½œåœ¨é—®é¢˜ | é‡è¯•æ“ä½œã€é…ç½®ç¼ºå¤± |
| `error` | é”™è¯¯ä¿¡æ¯ï¼Œéœ€è¦å…³æ³¨ | æ“ä½œå¤±è´¥ã€å¼‚å¸¸æ•è· |
| `fatal` | ä¸¥é‡é”™è¯¯ï¼ŒæœåŠ¡ä¸å¯ç”¨ | æœåŠ¡å´©æºƒã€è‡´å‘½é”™è¯¯ |

### 6.2 æ—¥å¿—æ ¼å¼

```typescript
// âœ… ç»“æ„åŒ–æ—¥å¿—
wsLogger.info(
  {
    connectionId,
    messageId: message.meta.messageId,
    action: message.payload.action,
    clientType: message.meta.clientType,
  },
  'å¤„ç† WebSocket æ¶ˆæ¯'
);

// âœ… å¸¦ä¸Šä¸‹æ–‡çš„é”™è¯¯æ—¥å¿—
serviceLogger.error(
  {
    error,
    stack: error.stack,
    taskName,
    params,
  },
  'AI ä»»åŠ¡æ‰§è¡Œå¤±è´¥'
);

// âŒ ä¸è¦ä½¿ç”¨ç®€å•å­—ç¬¦ä¸²
logger.info('å¤„ç†æ¶ˆæ¯');  // ç¼ºå°‘ä¸Šä¸‹æ–‡
logger.error(error.message);  // ç¼ºå°‘å †æ ˆä¿¡æ¯
```

### 6.3 ä¸“ç”¨ Logger

```typescript
// ä¸ºä¸åŒæ¨¡å—åˆ›å»ºä¸“ç”¨ logger
export const wsLogger = createLogger('websocket');
export const serverLogger = createLogger('server');
export const serviceLogger = createLogger('service');
export const controllerLogger = createLogger('controller');

// ä½¿ç”¨ç¤ºä¾‹
wsLogger.info({ connectionId }, 'WebSocket è¿æ¥å»ºç«‹');
serviceLogger.debug({ agent }, 'åˆ›å»º Agent å®ä¾‹');
```

### 6.4 æ—¥å¿—ä¸Šä¸‹æ–‡

```typescript
// âœ… è®¾ç½®æ—¥å¿—ä¸Šä¸‹æ–‡ï¼ˆè‡ªåŠ¨æ·»åŠ åˆ°æ‰€æœ‰æ—¥å¿—ï¼‰
setLogContextFromMessage(message, connectionId);

// âœ… åœ¨å¼‚æ­¥æ“ä½œä¸­ä½¿ç”¨ä¸Šä¸‹æ–‡
await withLogContext(
  { messageId, conversationId },
  async () => {
    // æ‰€æœ‰æ—¥å¿—è‡ªåŠ¨åŒ…å«ä¸Šä¸‹æ–‡
    serviceLogger.info('å¼€å§‹æ‰§è¡Œä»»åŠ¡');
  }
);
```

### 6.5 æ€§èƒ½æ—¥å¿—

```typescript
// âœ… è®°å½•æ€§èƒ½æŒ‡æ ‡
const startTime = Date.now();
await executeTask();
const duration = Date.now() - startTime;

serviceLogger.info(
  {
    taskName,
    duration,
    performance: {
      startTime,
      endTime: Date.now(),
    },
  },
  `ä»»åŠ¡æ‰§è¡Œå®Œæˆï¼Œè€—æ—¶ ${duration}ms`
);
```

---

## 7. WebSocket é€šä¿¡è§„èŒƒ

### 7.1 æ¶ˆæ¯ç»“æ„

#### å…¥ç«™æ¶ˆæ¯ï¼ˆå®¢æˆ·ç«¯ -> æœåŠ¡ç«¯ï¼‰

```typescript
interface WsInboundMessage<P = unknown> {
  meta: {
    messageId: string;        // æ¶ˆæ¯å”¯ä¸€ID
    conversationId: string;   // ä¼šè¯ID
    timestamp: number;        // æ—¶é—´æˆ³
    clientType?: 'web' | 'windows';  // å®¢æˆ·ç«¯ç±»å‹
  };
  payload: {
    action: WebSocketAction;  // æ“ä½œç±»å‹
    params: P;                // å‚æ•°
    site: string;            // ç«™ç‚¹ä¿¡æ¯
    originalCmd: string;     // åŸå§‹å‘½ä»¤
  };
}
```

#### å‡ºç«™æ¶ˆæ¯ï¼ˆæœåŠ¡ç«¯ -> å®¢æˆ·ç«¯ï¼‰

```typescript
interface WsOutboundMessage<R = unknown> {
  meta: {
    messageId: string;
    conversationId: string;
    timestamp: number;
  };
  payload: {
    action: WebSocketAction;
    status: 'success' | 'failed';
    result?: R;
    error?: string;
  };
}
```

### 7.2 Action å®šä¹‰

```typescript
// src/utils/enums.ts
export enum WebSocketAction {
  // åŸºç¡€æ“ä½œ
  EXECUTE = 'execute',
  EXECUTE_SCRIPT = 'execute_script',
  COMMAND = 'command',

  // è¿æ¥ç®¡ç†
  CONNECT = 'connect',
  CONNECT_WINDOW = 'connect_window',

  // å›è°ƒ
  CALLBACK_AI_STEP = 'callback_ai_step',

  // å…¶ä»–
  DOWNLOAD_VIDEO = 'download_video',
}
```

### 7.3 Handler å®ç°è§„èŒƒ

```typescript
// âœ… ä½¿ç”¨å·¥å‚å‡½æ•°åˆ›å»º Handler
export const handleExecute = createAiHandlerFactory(
  () => WebOperateServiceRefactored.getInstance(),
  'Web',
  { checkAndReconnect: true, supportMask: true }
);

// âœ… è‡ªå®šä¹‰ Handler æ¨¡å¼
export const handleConnect: MessageHandler = async (
  { connectionId, send },
  message
) => {
  // 1. è®¾ç½®æ—¥å¿—ä¸Šä¸‹æ–‡
  setLogContextFromMessage(message, connectionId);

  // 2. è®°å½•å¼€å§‹æ—¥å¿—
  wsLogger.info({ action: 'connect' }, 'å¤„ç†è¿æ¥è¯·æ±‚');

  try {
    // 3. æ‰§è¡Œä¸šåŠ¡é€»è¾‘
    const result = await processConnect(message.payload.params);

    // 4. å‘é€æˆåŠŸå“åº”
    const response = createSuccessResponse(message, result);
    send(response);

    // 5. è®°å½•æˆåŠŸæ—¥å¿—
    wsLogger.info({ action: 'connect' }, 'è¿æ¥æˆåŠŸ');
  } catch (error) {
    // 6. é”™è¯¯å¤„ç†
    wsLogger.error({ error }, 'è¿æ¥å¤±è´¥');

    // 7. å‘é€é”™è¯¯å“åº”
    const errorResponse = createErrorResponse(
      message,
      error as Error,
      'è¿æ¥å¤±è´¥'
    );
    send(errorResponse);
  }
};
```

### 7.4 æ¶ˆæ¯æ„å»ºå™¨

```typescript
// ä½¿ç”¨ç»Ÿä¸€çš„æ¶ˆæ¯æ„å»ºå™¨
import {
  createSuccessResponse,
  createErrorResponse,
  createSuccessResponseWithMeta,
} from '@/websocket/builders/messageBuilder';

// âœ… æˆåŠŸå“åº”
const response = createSuccessResponse(message, result);

// âœ… é”™è¯¯å“åº”
const errorResponse = createErrorResponse(message, error, 'æ“ä½œå¤±è´¥');

// âœ… å¸¦å…ƒæ•°æ®çš„å“åº”
const responseWithMeta = createSuccessResponseWithMeta(
  message,
  result,
  { duration: 1000 }
);
```

---

## 8. æµ‹è¯•è§„èŒƒ

### 8.1 æµ‹è¯•æ¡†æ¶

é¡¹ç›®ä½¿ç”¨ **Vitest** è¿›è¡Œæµ‹è¯•ï¼Œé…ç½®æ–‡ä»¶ï¼š`vitest.config.ts`

### 8.2 æµ‹è¯•æ–‡ä»¶ç»„ç»‡

```
src/
â”œâ”€â”€ services/
â”‚   â”œâ”€â”€ base/
â”‚   â”‚   â”œâ”€â”€ BaseOperateService.ts
â”‚   â”‚   â””â”€â”€ __tests__/
â”‚   â”‚       â””â”€â”€ BaseOperateService.test.ts
â”‚   â””â”€â”€ webOperateService.ts
â””â”€â”€ utils/
    â”œâ”€â”€ error.ts
    â””â”€â”€ __tests__/
        â””â”€â”€ error.test.ts
```

### 8.3 æµ‹è¯•å‘½å

```typescript
// âœ… ä½¿ç”¨æè¿°æ€§çš„æµ‹è¯•åç§°
describe('BaseOperateService', () => {
  describe('çŠ¶æ€ç®¡ç†', () => {
    it('åº”è¯¥æ­£ç¡®åˆå§‹åŒ–ä¸º STOPPED çŠ¶æ€', () => { });
    it('å½“è°ƒç”¨ start() æ—¶åº”è¯¥è½¬æ¢åˆ° STARTING çŠ¶æ€', () => { });
    it('å½“å¯åŠ¨å¤±è´¥æ—¶åº”è¯¥å›é€€åˆ° STOPPED çŠ¶æ€', () => { });
  });

  describe('ä»»åŠ¡æ‰§è¡Œ', () => {
    it('åº”è¯¥æˆåŠŸæ‰§è¡Œ AI ä»»åŠ¡å¹¶è¿”å›ç»“æœ', () => { });
    it('å½“ Agent æœªåˆå§‹åŒ–æ—¶åº”è¯¥æŠ›å‡ºé”™è¯¯', () => { });
  });
});
```

### 8.4 æµ‹è¯•è¦†ç›–ç‡ç›®æ ‡

| ç±»å‹ | è¦†ç›–ç‡ç›®æ ‡ |
|------|----------|
| æ ¸å¿ƒæœåŠ¡ç±» | â‰¥ 85% |
| Handler å‡½æ•° | â‰¥ 80% |
| å·¥å…·å‡½æ•° | â‰¥ 90% |
| ç±»å‹å®šä¹‰ | N/A |

### 8.5 æµ‹è¯•å‘½ä»¤

```bash
# è¿è¡Œæ‰€æœ‰æµ‹è¯•
pnpm test

# è¿è¡Œæµ‹è¯•å¹¶æŸ¥çœ‹è¦†ç›–ç‡
pnpm test:coverage

# è¿è¡Œæµ‹è¯• UI
pnpm test:ui

# ç›‘å¬æ¨¡å¼
pnpm test:watch
```

### 8.6 æµ‹è¯•ç¤ºä¾‹

```typescript
import { describe, it, expect, beforeEach, afterEach } from 'vitest';
import { BaseOperateService } from '../BaseOperateService';

describe('BaseOperateService', () => {
  let service: TestOperateService;

  beforeEach(() => {
    service = new TestOperateService();
  });

  afterEach(() => {
    service.resetInstance();
  });

  it('åº”è¯¥æ­£ç¡®åˆå§‹åŒ–çŠ¶æ€', () => {
    expect(service.getState()).toBe(OperateServiceState.STOPPED);
  });

  it('åº”è¯¥æˆåŠŸå¯åŠ¨æœåŠ¡', async () => {
    await service.start();
    expect(service.getState()).toBe(OperateServiceState.RUNNING);
  });
});
```

---

## 9. æ–‡æ¡£è§„èŒƒ

### 9.1 æ–‡æ¡£åˆ†ç±»

```
docs/
â”œâ”€â”€ åŠŸèƒ½å¼€å‘/          # æ–°åŠŸèƒ½å¼€å‘æ–‡æ¡£
â”œâ”€â”€ æ¶æ„é‡æ„/          # æ¶æ„é‡æ„æ–‡æ¡£
â”œâ”€â”€ é—®é¢˜ä¿®å¤/          # Bug ä¿®å¤æ–‡æ¡£
â”œâ”€â”€ æ€§èƒ½ä¼˜åŒ–/          # æ€§èƒ½ä¼˜åŒ–æ–‡æ¡£
â””â”€â”€ å¼€å‘è§„èŒƒ.md        # æœ¬æ–‡æ¡£
```

### 9.2 ä½•æ—¶ç¼–å†™æ–‡æ¡£

#### âœ… å¿…é¡»ç¼–å†™æ–‡æ¡£çš„åœºæ™¯

1. **å¤§å‹é‡æ„**ï¼šæ¶‰åŠæ ¸å¿ƒæ¶æ„å˜æ›´
2. **æ–°åŠŸèƒ½å¼€å‘**ï¼šç‹¬ç«‹æ¨¡å—æˆ–é‡è¦ç‰¹æ€§
3. **é«˜ä»·å€¼é—®é¢˜ä¿®å¤**ï¼šæŠ€æœ¯éš¾é¢˜ã€ç½•è§é—®é¢˜
4. **æ€§èƒ½ä¼˜åŒ–**ï¼šæ˜¾è‘—çš„æ€§èƒ½æå‡æ–¹æ¡ˆ

#### âŒ ä¸éœ€è¦æ–‡æ¡£çš„åœºæ™¯

1. ç®€å•çš„ Bug ä¿®å¤
2. ä»£ç æ ¼å¼è°ƒæ•´
3. æ³¨é‡Šæ›´æ–°
4. ä¾èµ–å‡çº§ï¼ˆæ—  Breaking Changesï¼‰

### 9.3 æ–‡æ¡£æ¨¡æ¿

#### åŠŸèƒ½å¼€å‘æ–‡æ¡£æ¨¡æ¿

```markdown
# <åŠŸèƒ½åç§°>

> **å¼€å‘æ—¥æœŸ**: YYYYå¹´MMæœˆDDæ—¥
> **è´Ÿè´£äºº**: [å§“å]
> **ç›¸å…³ Issue**: #<issue_number>

## èƒŒæ™¯

ç®€è¿°åŠŸèƒ½å¼€å‘çš„èƒŒæ™¯å’Œéœ€æ±‚ã€‚

## åŠŸèƒ½è®¾è®¡

### æ¶æ„è®¾è®¡

### æŠ€æœ¯é€‰å‹

### æ¥å£è®¾è®¡

## å®ç°ç»†èŠ‚

### æ ¸å¿ƒä»£ç 

### å…³é”®é€»è¾‘

## æµ‹è¯•

### å•å…ƒæµ‹è¯•

### é›†æˆæµ‹è¯•

## éƒ¨ç½²

### é…ç½®å˜æ›´

### æ•°æ®åº“è¿ç§»

## æ€»ç»“

### é‡åˆ°çš„é—®é¢˜

### ç»éªŒæ•™è®­
```

#### é—®é¢˜ä¿®å¤æ–‡æ¡£æ¨¡æ¿

```markdown
# <é—®é¢˜æ ‡é¢˜>

> **ä¿®å¤æ—¥æœŸ**: YYYYå¹´MMæœˆDDæ—¥
> **é—®é¢˜çº§åˆ«**: P0/P1/P2
> **å½±å“èŒƒå›´**: [æè¿°]

## é—®é¢˜æè¿°

è¯¦ç»†æè¿°é—®é¢˜ç°è±¡ã€‚

## é—®é¢˜åŸå› 

æ ¹æœ¬åŸå› åˆ†æã€‚

## è§£å†³æ–¹æ¡ˆ

### æ–¹æ¡ˆå¯¹æ¯”

### æœ€ç»ˆæ–¹æ¡ˆ

## ä¿®å¤ä»£ç 

å…³é”®ä»£ç ç‰‡æ®µå’Œè¯´æ˜ã€‚

## æµ‹è¯•éªŒè¯

æµ‹è¯•æ­¥éª¤å’Œç»“æœã€‚

## é¢„é˜²æªæ–½

å¦‚ä½•é¿å…ç±»ä¼¼é—®é¢˜ã€‚
```

### 9.4 æ–‡æ¡£å‘½åè§„èŒƒ

- âœ… **ä½¿ç”¨ä¸­æ–‡åç§°**ï¼šå‡†ç¡®æ¦‚æ‹¬å†…å®¹
- âœ… **ç®€æ´æ˜äº†**ï¼šä¸è¶…è¿‡ 20 ä¸ªæ±‰å­—
- âœ… **åŒ…å«å…³é”®è¯**ï¼šä¾¿äºæœç´¢

ç¤ºä¾‹ï¼š

- `æœåŠ¡å±‚é‡æ„æ–¹æ¡ˆ.md`
- `Windowsç‚¹å‡»ä½ç½®åå·®é—®é¢˜ä¿®å¤.md`
- `node-screenshotsé›†æˆä¸çª—å£çº§æˆªå›¾åŠŸèƒ½.md`

### 9.5 ä»£ç æ³¨é‡Šè§„èŒƒ

```typescript
/**
 * BaseOperateService - æ“ä½œæœåŠ¡åŸºç±»
 *
 * æä¾› Web å’Œ Windows æœåŠ¡çš„å…¬å…±åŠŸèƒ½ï¼š
 * - çŠ¶æ€ç®¡ç†
 * - å›è°ƒæœºåˆ¶
 * - ç”Ÿå‘½å‘¨æœŸç®¡ç†
 * - Report ç”Ÿæˆå’Œä¸Šä¼ 
 *
 * @example
 * ```typescript
 * class MyService extends BaseOperateService<MyAgent> {
 *   protected async createAgent() {
 *     // å®ç° Agent åˆ›å»º
 *   }
 * }
 * ```
 */
export abstract class BaseOperateService<TAgent> {
  /**
   * Agent å®ä¾‹
   * @public
   */
  public agent: TAgent | null = null;

  /**
   * åˆ›å»º Agent å®ä¾‹
   * å­ç±»éœ€è¦å®ç°è‡ªå·±çš„ Agent åˆ›å»ºé€»è¾‘
   *
   * @abstract
   * @protected
   */
  protected abstract createAgent(): Promise<void>;
}
```

---

## 10. Git æäº¤è§„èŒƒ

### 10.1 æäº¤æ¶ˆæ¯æ ¼å¼

```
<type>(<scope>): <subject>

<body>

<footer>
```

### 10.2 Type ç±»å‹

| Type | è¯´æ˜ | ç¤ºä¾‹ |
|------|------|------|
| `feat` | æ–°åŠŸèƒ½ | `feat(service): æ·»åŠ  Windows æœåŠ¡æ”¯æŒ` |
| `fix` | Bug ä¿®å¤ | `fix(websocket): ä¿®å¤è¿æ¥æ–­å¼€é—®é¢˜` |
| `refactor` | é‡æ„ | `refactor(service): æå–å…¬å…±åŸºç±»` |
| `docs` | æ–‡æ¡£ | `docs: æ›´æ–°å¼€å‘è§„èŒƒ` |
| `style` | æ ¼å¼ | `style: ç»Ÿä¸€ä»£ç æ ¼å¼` |
| `test` | æµ‹è¯• | `test(service): æ·»åŠ å•å…ƒæµ‹è¯•` |
| `chore` | æ„å»º/å·¥å…· | `chore: å‡çº§ä¾èµ–ç‰ˆæœ¬` |
| `perf` | æ€§èƒ½ä¼˜åŒ– | `perf(service): ä¼˜åŒ–ä»»åŠ¡æ‰§è¡Œæ€§èƒ½` |

### 10.3 Scope èŒƒå›´

- `service`: æœåŠ¡å±‚
- `websocket`: WebSocket å±‚
- `handler`: Handler å¤„ç†
- `util`: å·¥å…·å‡½æ•°
- `type`: ç±»å‹å®šä¹‰
- `config`: é…ç½®
- `test`: æµ‹è¯•

### 10.4 æäº¤ç¤ºä¾‹

```bash
# âœ… å¥½çš„æäº¤
git commit -m "feat(service): æ·»åŠ  BaseOperateService æŠ½è±¡åŸºç±»"
git commit -m "fix(websocket): ä¿®å¤æ¶ˆæ¯ ID ä¸ä¸€è‡´é—®é¢˜"
git commit -m "refactor(handler): ä½¿ç”¨å·¥å‚æ¨¡å¼é‡æ„ Handler"

# âŒ ä¸å¥½çš„æäº¤
git commit -m "æ›´æ–°ä»£ç "
git commit -m "ä¿®å¤ bug"
git commit -m "WIP"
```

---

## 11. æœåŠ¡å±‚å¼€å‘è§„èŒƒ

### 11.1 Service ç±»ç»“æ„

```typescript
export class MyService extends BaseOperateService<MyAgent> {
  // 1. é™æ€å•ä¾‹
  private static instance: MyService | null = null;

  // 2. ç§æœ‰æ„é€ å‡½æ•°
  private constructor() {
    super();
  }

  // 3. è·å–å®ä¾‹
  public static getInstance(): MyService {
    if (!MyService.instance) {
      MyService.instance = new MyService();
    }
    return MyService.instance;
  }

  // 4. é‡ç½®å®ä¾‹ï¼ˆæµ‹è¯•ç”¨ï¼‰
  public static resetInstance(): void {
    MyService.instance = null;
  }

  // 5. å®ç°æŠ½è±¡æ–¹æ³•
  protected async createAgent(): Promise<void> {
    // å®ç°
  }

  protected async initializeConnection(): Promise<void> {
    // å®ç°
  }

  protected getServiceName(): string {
    return 'MyService';
  }

  // 6. å…¬å…±æ–¹æ³•
  public async execute(params: any): Promise<any> {
    // å®ç°
  }
}
```

### 11.2 Service æ–¹æ³•è§„èŒƒ

```typescript
// âœ… æ–¹æ³•åº”è¯¥å•ä¸€èŒè´£
public async executeTask(task: Task): Promise<Result> {
  // 1. å‚æ•°éªŒè¯
  this.validateTask(task);

  // 2. çŠ¶æ€æ£€æŸ¥
  this.checkServiceState();

  // 3. æ‰§è¡Œä»»åŠ¡
  const result = await this.performTask(task);

  // 4. å¤„ç†ç»“æœ
  return this.processResult(result);
}

// âŒ é¿å…æ–¹æ³•è¿‡é•¿
public async executeTask(task: Task): Promise<Result> {
  // 300 è¡Œä»£ç ...
}
```

### 11.3 çŠ¶æ€ç®¡ç†

```typescript
// âœ… ä½¿ç”¨æšä¸¾ç®¡ç†çŠ¶æ€
enum ServiceState {
  STOPPED = 'stopped',
  STARTING = 'starting',
  RUNNING = 'running',
  STOPPING = 'stopping',
}

// âœ… æä¾›çŠ¶æ€æŸ¥è¯¢å’Œè½¬æ¢æ–¹æ³•
public getState(): ServiceState {
  return this.state;
}

protected setState(newState: ServiceState): void {
  const oldState = this.state;
  this.state = newState;
  this.emit('stateChanged', { oldState, newState });
}
```

---

## 12. æ–‡ä»¶ç»„ç»‡è§„èŒƒ

### 12.1 ç›®å½•ç»“æ„

```
apps/server/src/
â”œâ”€â”€ config/              # é…ç½®æ–‡ä»¶
â”‚   â”œâ”€â”€ clientTypeActions.ts
â”‚   â””â”€â”€ index.ts
â”œâ”€â”€ mastra/              # Mastra é›†æˆ
â”‚   â”œâ”€â”€ agents/
â”‚   â”œâ”€â”€ tools/
â”‚   â””â”€â”€ mcp/
â”œâ”€â”€ middleware/          # ä¸­é—´ä»¶
â”‚   â””â”€â”€ logger.ts
â”œâ”€â”€ routes/              # è·¯ç”±å¤„ç†
â”‚   â”œâ”€â”€ modules/
â”‚   â””â”€â”€ index.ts
â”œâ”€â”€ services/            # ä¸šåŠ¡æœåŠ¡
â”‚   â”œâ”€â”€ base/           # åŸºç¡€æœåŠ¡
â”‚   â”‚   â”œâ”€â”€ BaseOperateService.ts
â”‚   â”‚   â”œâ”€â”€ WebOperateServiceRefactored.ts
â”‚   â”‚   â””â”€â”€ __tests__/
â”‚   â””â”€â”€ customMidsceneDevice/
â”œâ”€â”€ types/               # ç±»å‹å®šä¹‰
â”‚   â”œâ”€â”€ index.ts
â”‚   â”œâ”€â”€ websocket.ts
â”‚   â””â”€â”€ windowsProtocol.ts
â”œâ”€â”€ utils/               # å·¥å…·å‡½æ•°
â”‚   â”œâ”€â”€ logger.ts
â”‚   â”œâ”€â”€ error.ts
â”‚   â”œâ”€â”€ response.ts
â”‚   â””â”€â”€ __tests__/
â”œâ”€â”€ websocket/           # WebSocket å¤„ç†
â”‚   â”œâ”€â”€ actions/        # Action å¤„ç†å™¨
â”‚   â”‚   â”œâ”€â”€ base/
â”‚   â”‚   â”œâ”€â”€ web/
â”‚   â”‚   â””â”€â”€ windows/
â”‚   â”œâ”€â”€ builders/       # æ¶ˆæ¯æ„å»ºå™¨
â”‚   â”œâ”€â”€ handlers/       # æ¶ˆæ¯å¤„ç†å™¨
â”‚   â””â”€â”€ helpers/        # è¾…åŠ©å‡½æ•°
â””â”€â”€ index.ts            # å…¥å£æ–‡ä»¶
```

### 12.2 æ¨¡å—å¯¼å‡ºè§„èŒƒ

```typescript
// âœ… ä½¿ç”¨ index.ts é›†ä¸­å¯¼å‡º
// src/services/base/index.ts
export { BaseOperateService } from './BaseOperateService';
export { WebOperateServiceRefactored } from './WebOperateServiceRefactored';
export { WindowsOperateServiceRefactored } from './WindowsOperateServiceRefactored';

// âœ… ç±»å‹å’Œå®ç°åˆ†å¼€å¯¼å‡º
export type { TaskTipCallback, TaskError } from './BaseOperateService';
export { OperateServiceState } from './BaseOperateService';
```

### 12.3 Import é¡ºåº

```typescript
// 1. Node.js å†…ç½®æ¨¡å—
import { EventEmitter } from 'node:events';
import path from 'node:path';

// 2. ç¬¬ä¸‰æ–¹ä¾èµ–
import type { AgentOverChromeBridge } from '@midscene/web/bridge-mode';
import { Hono } from 'hono';

// 3. å†…éƒ¨æ¨¡å—ï¼ˆä½¿ç”¨åˆ«åï¼‰
import type { WebSocketMessage } from '@/types/websocket';
import { serviceLogger } from '@/utils/logger';
import { createSuccessResponse } from '@/websocket/builders/messageBuilder';

// 4. ç›¸å¯¹è·¯å¾„å¯¼å…¥
import { helper } from './helper';
import type { LocalType } from './types';
```

---

## 13. æ€§èƒ½ä¼˜åŒ–è§„èŒƒ

### 13.1 å¼‚æ­¥æ“ä½œ

```typescript
// âœ… ä½¿ç”¨ Promise.all å¹¶è¡Œæ‰§è¡Œ
const [result1, result2, result3] = await Promise.all([
  fetchData1(),
  fetchData2(),
  fetchData3(),
]);

// âŒ é¿å…ä¸²è¡Œæ‰§è¡Œ
const result1 = await fetchData1();
const result2 = await fetchData2();
const result3 = await fetchData3();
```

### 13.2 ç¼“å­˜ç­–ç•¥

```typescript
// âœ… å®ç°ç¼“å­˜æœºåˆ¶
class ServiceWithCache {
  private cache = new Map<string, any>();

  async getData(key: string): Promise<any> {
    if (this.cache.has(key)) {
      return this.cache.get(key);
    }

    const data = await fetchData(key);
    this.cache.set(key, data);
    return data;
  }

  clearCache(): void {
    this.cache.clear();
  }
}
```

### 13.3 èµ„æºç®¡ç†

```typescript
// âœ… åŠæ—¶é‡Šæ”¾èµ„æº
class ResourceManager {
  private resources: Resource[] = [];

  async cleanup(): Promise<void> {
    for (const resource of this.resources) {
      await resource.close();
    }
    this.resources = [];
  }
}

// âœ… ä½¿ç”¨ finally ç¡®ä¿æ¸…ç†
async function processData() {
  const connection = await createConnection();
  try {
    return await connection.query();
  } finally {
    await connection.close();
  }
}
```

### 13.4 æ€§èƒ½ç›‘æ§

```typescript
// âœ… è®°å½•å…³é”®æ“ä½œçš„æ€§èƒ½æŒ‡æ ‡
async function executeTaskWithMetrics(task: Task) {
  const startTime = performance.now();

  try {
    const result = await executeTask(task);
    const duration = performance.now() - startTime;

    serviceLogger.info({
      taskId: task.id,
      duration,
      success: true,
    }, `ä»»åŠ¡æ‰§è¡ŒæˆåŠŸï¼Œè€—æ—¶ ${duration}ms`);

    return result;
  } catch (error) {
    const duration = performance.now() - startTime;

    serviceLogger.error({
      taskId: task.id,
      duration,
      success: false,
    }, `ä»»åŠ¡æ‰§è¡Œå¤±è´¥ï¼Œè€—æ—¶ ${duration}ms`);

    throw error;
  }
}
```

---

## 14. å®‰å…¨è§„èŒƒ

### 14.1 ç¯å¢ƒå˜é‡

```typescript
// âœ… ä½¿ç”¨ç¯å¢ƒå˜é‡å­˜å‚¨æ•æ„Ÿä¿¡æ¯
const apiKey = process.env.API_KEY;
const dbPassword = process.env.DB_PASSWORD;

// âŒ ä¸è¦ç¡¬ç¼–ç æ•æ„Ÿä¿¡æ¯
const apiKey = 'sk-1234567890abcdef';  // å±é™©ï¼
```

### 14.2 è¾“å…¥éªŒè¯

```typescript
// âœ… éªŒè¯æ‰€æœ‰å¤–éƒ¨è¾“å…¥
function processUserInput(input: unknown): string {
  if (typeof input !== 'string') {
    throw new AppError('Invalid input type', 400);
  }

  if (input.length > 1000) {
    throw new AppError('Input too long', 400);
  }

  // æ¸…ç†å’ŒéªŒè¯è¾“å…¥
  return sanitizeInput(input);
}
```

### 14.3 æ—¥å¿—è„±æ•

```typescript
// âœ… è„±æ•æ•æ„Ÿä¿¡æ¯
function sanitizeLogData(data: any) {
  return {
    ...data,
    password: '***',
    apiKey: data.apiKey?.slice(0, 8) + '...',
    token: '***',
  };
}

serviceLogger.info(
  sanitizeLogData(userData),
  'ç”¨æˆ·ç™»å½•'
);
```

---

## é™„å½•

### A. å¿«é€Ÿå‚è€ƒ

#### å¸¸ç”¨å‘½ä»¤

```bash
# å¼€å‘
pnpm dev

# æ„å»º
pnpm build

# æµ‹è¯•
pnpm test
pnpm test:coverage

# ä»£ç è´¨é‡
pnpm lint
pnpm format
pnpm check
pnpm fix
```

#### ç›®å½•æ˜ å°„

```typescript
// tsconfig.json paths
{
  "@/*": ["./src/*"],
  "@/types/*": ["./src/types/*"],
  "@/utils/*": ["./src/utils/*"],
  "@/services/*": ["./src/services/*"]
}
```

### B. ç›¸å…³æ–‡æ¡£

- [æœåŠ¡å±‚é‡æ„æ–¹æ¡ˆ](./æ¶æ„é‡æ„/æœåŠ¡å±‚é‡æ„æ–¹æ¡ˆ.md)
- [ä»£ç å¯¹æ¯”ä¸è¿ç§»æŒ‡å—](./æ¶æ„é‡æ„/ä»£ç å¯¹æ¯”ä¸è¿ç§»æŒ‡å—.md)
- [WebSocketä¼ å€¼è¯´æ˜](./WebSocketä¼ å€¼è¯´æ˜.md)
- [Monorepoä½¿ç”¨æŒ‡å—](./Monorepoä½¿ç”¨æŒ‡å—.md)

### C. å·¥å…·é“¾æ¥

- [Biome æ–‡æ¡£](https://biomejs.dev/)
- [Vitest æ–‡æ¡£](https://vitest.dev/)
- [TypeScript æ–‡æ¡£](https://www.typescriptlang.org/)
- [Hono æ–‡æ¡£](https://hono.dev/)
- [Midscene æ–‡æ¡£](https://midscenejs.com/)

---

**æ–‡æ¡£ç»´æŠ¤**ï¼šæœ¬æ–‡æ¡£ç”±å›¢é˜Ÿå…±åŒç»´æŠ¤ï¼Œè¯·åœ¨è¿›è¡Œé‡å¤§å˜æ›´æ—¶åŠæ—¶æ›´æ–°ã€‚

**åé¦ˆæ¸ é“**ï¼šå¦‚æœ‰é—®é¢˜æˆ–å»ºè®®ï¼Œè¯·åˆ›å»º Issue æˆ–è”ç³»é¡¹ç›®è´Ÿè´£äººã€‚

**æœ€åæ›´æ–°**ï¼š2025å¹´10æœˆ24æ—¥
