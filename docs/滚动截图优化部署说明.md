# 滚动截图优化部署说明

## 问题说明

已实现基于 clip 参数的分段截图方案（参考 full-page-screen），作为 Emulation 方案的备选。但需要重新编译和部署 midscene 包才能生效。

## 部署步骤

### 1. 在 midscene 项目中重新编译

```bash
cd /Users/lebo/lebo/project/midscene

# 构建 web-integration 包（包含新的截图逻辑）
pnpm --filter @midscene/web build

# 打包为 tarball
cd packages/web-integration
pnpm pack

# 复制到 midscene-server 的 local-packages 目录
cp *.tgz ../../../midscene-server/local-packages/
```

### 2. 更新 midscene-server 依赖

```bash
cd /Users/lebo/lebo/project/midscene-server

# 清理旧的依赖
rm -rf apps/server/node_modules/@midscene/web

# 重新安装
pnpm install
```

### 3. 重新加载 Chrome Extension

**重要：** 必须重新加载扩展才能使新代码生效！

1. 打开 Chrome 扩展管理页面：`chrome://extensions/`
2. 找到 Midscene 扩展
3. 点击**"重新加载"**按钮（🔄）

### 4. 验证部署

在浏览器控制台（F12）观察日志，应该看到：

**如果 Emulation 失败，会尝试 Clip 方案：**

```
❌ Emulation screenshot failed: ...
⚠️  Falling back to clip-based screenshot method...
📏 [Clip] 页面尺寸信息: {page: "1920x5000", viewport: "1920x1080", dpr: 2}
📸 [Clip] 需要截图 3 个区域
📸 [Clip] 截图区域 1/3: (0, 4800) 1920x880
📸 [Clip] 截图区域 2/3: (0, 3920) 1920x880
...
🔗 [Clip] 开始拼接 3 个截图片段
✅ [Clip] 截图拼接完成，最终 base64 长度: ...
```

## 修改的文件

1. `packages/web-integration/src/chrome-extension/page.ts`
   - 新增 `screenshotFullPageByClip` 方法
   - 在 `screenshotFullPageBase64` 中集成 clip 方案作为备选

2. `packages/web-integration/src/chrome-extension/screenshot-stitcher.ts`（新建）
   - Canvas 拼接逻辑（在页面上下文中执行）

## 工作原理

1. **优先使用 Emulation**：尝试 `Emulation.setDeviceMetricsOverride`
2. **失败时使用 Clip**：分段截图 + Canvas 拼接
3. **最后回退到视口截图**：如果都失败

Clip 方案的优势：

- 无需滚动页面，避免页面状态变化
- 使用 CDP `Page.captureScreenshot` 的 `clip` 参数
- 在页面上下文中使用 Canvas 拼接

## 调试建议

如果截图仍然失败，检查：

1. **浏览器控制台日志**：查看是否有 `[Clip]` 相关的日志
   - 打开 F12 → Console 标签
   - 查找 `[Clip]` 或 `screenshotFullPageByClip` 相关的日志
   - 如果看到 `📸 [Clip] 需要截图 X 个区域`，说明 clip 方案已启动

2. **服务端日志**：查看截图尺寸是否合理
   - 如果看到 `⚠️  请求了全页截图但实际尺寸只有...`，说明全页截图失败
   - 检查是否有 `❌ Clip screenshot also failed` 错误

3. **Chrome Extension 是否已重新加载**：确保使用了新代码
   - 必须重新加载扩展才能使用新编译的代码

4. **检查拼接是否成功**：
   - 如果看到 `📸 [Clip] 截图区域 X/Y` 但最终图片很小，可能是拼接失败
   - 查看浏览器控制台是否有 Canvas 相关错误

## 可能的问题

### 问题 1：只截取了顶部内容

**原因**：可能是拼接逻辑有问题，或者只成功截取了第一个区域

**解决方案**：

- 检查浏览器控制台是否有 `🔗 [Clip] 开始拼接` 的日志
- 查看是否有 Canvas 拼接错误
- 确认所有区域都成功截图（查看 `📸 [Clip] 截图区域` 日志）

### 问题 2：滚动条快速闪动但截图失败

**原因**：可能是 clip 方案在执行，但拼接失败

**解决方案**：

- 查看浏览器控制台是否有异常
- 检查 Canvas API 是否可用
- 确认页面上下文是否允许执行 Canvas 操作

### 问题 3：代码没有生效

**原因**：没有重新编译或 Chrome Extension 没有重新加载

**解决方案**：

- 确认已执行 `pnpm --filter @midscene/web build`
- 确认已重新加载 Chrome Extension
- 检查 `node_modules/@midscene/web` 中的代码是否是最新的
