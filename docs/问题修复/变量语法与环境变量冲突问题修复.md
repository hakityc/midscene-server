# 变量语法与环境变量冲突问题修复

## 问题描述

### 错误信息

```
AI 脚本: AI 处理失败: 脚本执行失败: Environment variable "专利模板" is not defined
```

### 问题表现

用户在前端输入框中使用变量语法 `${专利模板}`，发送到后端执行时报错，提示环境变量未定义。

## 问题根源

### 1. 变量转换时机错误

**原始流程：**

```
用户输入 ${专利模板}
    ↓
buildAiScriptMessage(tasks, meta, option)
    ↓
flowActionToApiFormat(action)  // 转换为 API 格式
    ↓  {type: 'aiTap', locate: '${专利模板}'} → {aiTap: '${专利模板}'}
    ↓
transformTasks(params.tasks, 'runtime')  // ❌ 此时数据已是 API 格式
    ↓  无法找到 action.locate 字段，转换失败！
    ↓
发送到后端，YAML 中仍然包含 ${专利模板}
    ↓
Midscene 的 interpolateEnvVars 尝试解析为环境变量
    ↓
❌ 报错：Environment variable "专利模板" is not defined
```

### 2. 数据结构变化

**FlowAction 格式：**

```typescript
{
  type: 'aiTap',
  locate: '${专利模板}'  // ✅ transformAction 可以找到这个字段
}
```

**API 格式（经过 flowActionToApiFormat）：**

```typescript
{
  aiTap: '${专利模板}'  // ❌ transformAction 找不到 locate 字段
}
```

### 3. 变量语法冲突

前端的变量语法 `${xxx}` 与 Midscene 库的环境变量语法冲突：

- **前端设计**：`${专利模板}` 是 UI 层的变量占位符，发送时应去掉 `${}`
- **Midscene 设计**：YAML 中的 `${xxx}` 会被解析为系统环境变量（`process.env.xxx`）

## 解决方案

### 修改要点

将变量转换移到 `flowActionToApiFormat` 之前，在 FlowAction 格式还保持完整时进行转换。

### 代码修改

**文件：`midscene-server/apps/web/src/pages/midsceneDebugPage.tsx`**

#### 修改前

```typescript
// 构建消息
const buildMessage = useCallback((): WsInboundMessage | null => {
  const option = enableLoadingShade ? 'LOADING_SHADE' : undefined;

  switch (action) {
    case 'aiScript':
      return buildAiScriptMessage(tasks, meta, option);
    // ...
  }
}, [action, meta, tasks, enableLoadingShade, ...]);

// 发送消息（转换变量为运行时值）
const handleSend = useCallback(() => {
  const message = buildMessage();
  if (!message) return;

  // ❌ 在这里转换，数据已经是 API 格式
  let messageToSend = message;
  const params = message.payload?.params;
  if (
    message.payload?.action === 'aiScript' &&
    params &&
    typeof params === 'object' &&
    params !== null &&
    'tasks' in params &&
    Array.isArray(params.tasks)
  ) {
    messageToSend = {
      ...message,
      payload: {
        ...message.payload,
        params: {
          ...params,
          tasks: transformTasks(params.tasks, 'runtime'), // ❌ 转换失败
        },
      },
    };
  }

  send(messageToSend);
  addHistory(message);
  refreshMessageId();
}, [buildMessage, send, addHistory, refreshMessageId, transformTasks]);
```

#### 修改后

```typescript
// 构建消息
const buildMessage = useCallback(
  (mode: 'original' | 'runtime' = 'original'): WsInboundMessage | null => {
    const option = enableLoadingShade ? 'LOADING_SHADE' : undefined;

    switch (action) {
      case 'aiScript': {
        // ✅ 在 flowActionToApiFormat 之前转换变量
        const tasksToUse = mode === 'runtime'
          ? transformTasks(tasks, 'runtime')  // 转换：${专利模板} → 专利模板
          : tasks;
        return buildAiScriptMessage(tasksToUse, meta, option);
      }
      // ...
    }
  },
  [action, meta, tasks, enableLoadingShade, ..., transformTasks],
);

// 发送消息（转换变量为运行时值）
const handleSend = useCallback(() => {
  // ✅ 构建运行时消息（变量已转换）
  const messageToSend = buildMessage('runtime');
  if (!messageToSend) return;

  // 构建原始消息（用于历史记录，保留变量）
  const originalMessage = buildMessage('original');

  send(messageToSend);
  if (originalMessage) {
    addHistory(originalMessage);  // 历史记录保存原始值（包含变量）
  }
  refreshMessageId();
}, [buildMessage, send, addHistory, refreshMessageId]);
```

### 修复后的流程

```
用户输入 ${专利模板}
    ↓
handleSend() 调用 buildMessage('runtime')
    ↓
transformTasks(tasks, 'runtime')  // ✅ FlowAction 格式，转换成功
    ↓  ${专利模板} → 专利模板
    ↓
buildAiScriptMessage(转换后的tasks, meta, option)
    ↓
flowActionToApiFormat(action)  // 转换为 API 格式
    ↓  {type: 'aiTap', locate: '专利模板'} → {aiTap: '专利模板'}
    ↓
发送到后端，YAML 中是：aiTap: 专利模板
    ↓
Midscene 的 interpolateEnvVars 不会匹配（没有 ${}）
    ↓
✅ 正常执行
```

## 技术细节

### 变量转换逻辑

**核心函数（`useVariableTransform.ts`）：**

```typescript
const toRuntime = (text: string): string => {
  return text.replace(/\$\{([^}]+)\}/g, '$1');
};

const toPlaceholder = (text: string): string => {
  return text.replace(/\$\{([^}]+)\}/g, 'lbxx');
};

// 示例：
toRuntime('点击${专利模板}按钮')    // → '点击专利模板按钮'
toPlaceholder('点击${专利模板}按钮') // → '点击lbxx按钮'
toRuntime('${变量1}和${变量2}')     // → '变量1和变量2'
```

### API 格式支持

**问题**：JsonPreview 接收的数据已经是 API 格式（如 `{aiTap: "${专利模板}"}`），而不是 FlowAction 格式（如 `{type: 'aiTap', locate: "${专利模板}"}`）。

**解决方案**：修改 `transformAction` 函数，同时支持两种格式：

```typescript
const transformAction = (action, mode) => {
  const processed = { ...action };

  // 处理 FlowAction 格式的字段
  const fields = getActionVariableFields(action);
  fields.forEach(field => {
    const value = action[field];
    if (typeof value === 'string' && hasVariables(value)) {
      processed[field] = transform(value);
    }
  });

  // 处理 API 格式的字段（新增）
  const apiFields = [
    'aiTap', 'aiInput', 'aiAssert', 'aiHover', 'aiScroll', 'aiWaitFor',
    'aiKeyboardPress', 'aiDoubleClick', 'aiRightClick', 'aiQuery',
    'aiString', 'aiNumber', 'aiBoolean', 'aiAction', 'aiLocate',
    'screenshot', 'logText', 'logScreenshot', 'javascript', 'setClipboard',
    'activateWindow', 'sleep', 'getClipboard', 'getWindowList'
  ];

  apiFields.forEach(field => {
    const value = action[field];
    if (typeof value === 'string' && hasVariables(value)) {
      processed[field] = transform(value);
    }
  });

  return processed;
};
```

### transformAction 的字段识别

`transformAction` 会根据动作类型识别需要转换的字段：

```typescript
const getActionVariableFields = (action: FlowAction): string[] => {
  const fields: string[] = [];

  switch (action.type) {
    case 'aiTap':
      if (action.locate) fields.push('locate');
      break;
    case 'aiInput':
      fields.push('value', 'locate');
      break;
    case 'aiAssert':
      fields.push('assertion');
      if (action.errorMessage) fields.push('errorMessage');
      break;
    // ... 更多动作类型
  }

  return fields;
};
```

### Midscene 的环境变量解析

**文件：`midscene/packages/core/src/yaml/utils.ts`**

```typescript
export function interpolateEnvVars(content: string): string {
  return content.replace(/\$\{([^}]+)\}/g, (_, envVar) => {
    const value = process.env[envVar.trim()];
    if (value === undefined) {
      throw new Error(`Environment variable "${envVar.trim()}" is not defined`);
    }
    return value;
  });
}
```

这个函数会在 YAML 解析时被调用，将 `${xxx}` 替换为环境变量值。

## 验证测试

### 测试用例

```javascript
const toRuntime = (text) => {
  if (typeof text !== 'string') return text;
  return text.replace(/\$\{([^}]+)\}/g, '$1');
};

// 测试 1
console.log(toRuntime('点击${专利模板}按钮'));
// 输出: '点击专利模板按钮'

// 测试 2
console.log(toRuntime('输入${测试内容}'));
// 输出: '输入测试内容'

// 测试 3
console.log(toRuntime('${变量1}和${变量2}'));
// 输出: '变量1和变量2'
```

### 预期结果

- ✅ 前端输入 `${专利模板}` 会被正确转换为 `专利模板`
- ✅ 后端收到的 YAML 中不包含 `${}`，避免环境变量解析冲突
- ✅ 历史记录保留原始变量语法，方便复用

## 注意事项

### 1. 变量转换时机

**关键原则：在数据结构转换（FlowAction → API 格式）之前进行变量转换。**

- ✅ **正确**：transformTasks → buildAiScriptMessage → flowActionToApiFormat
- ❌ **错误**：buildAiScriptMessage → flowActionToApiFormat → transformTasks

### 2. 历史记录处理

```typescript
// 发送运行时消息（变量已转换）
const messageToSend = buildMessage('runtime');
send(messageToSend);

// 保存原始消息（保留变量语法）
const originalMessage = buildMessage('original');
addHistory(originalMessage);
```

### 3. JSON 预览

JSON 预览使用 `placeholder` 模式，将变量替换为占位符 `lbxx`：

```typescript
// 预览使用占位符
const previewParams = transformTasks(params.tasks, 'placeholder');
// ${专利模板} → lbxx
```

## 相关文件

### 修改文件

- `apps/web/src/pages/midsceneDebugPage.tsx` - 修复变量转换时机
- `apps/web/src/hooks/useVariableTransform.ts` - 增加 API 格式支持

### 相关文件

- `apps/web/src/hooks/useVariableTransform.ts` - 变量转换逻辑
- `apps/web/src/components/ui/variable-input.tsx` - 变量输入框组件
- `apps/web/src/components/ui/variable-textarea.tsx` - 变量文本框组件
- `apps/web/src/components/debug/JsonPreview.tsx` - JSON 预览组件
- `apps/web/src/utils/messageBuilder.ts` - 消息构建工具

### 依赖库

- `midscene/packages/core/src/yaml/utils.ts` - Midscene 环境变量解析

## 总结

### 问题本质

前端的变量占位符语法 `${xxx}` 与 Midscene 库的环境变量语法冲突，且变量转换时机错误导致转换失败。

### 解决方案

1. **提前转换**：在数据结构转换前进行变量转换
2. **双版本消息**：发送时使用 runtime 版本，历史记录使用 original 版本
3. **清晰职责**：
   - 前端负责在发送前去掉 `${}`
   - 后端不需要关心前端的变量语法
   - Midscene 只处理真正的环境变量

### 适用场景

此修复方案适用于所有使用前端变量语法的场景，确保：

- ✅ 用户可以在 UI 中使用 `${变量名}` 语法
- ✅ 变量会被正确转换并发送到后端
- ✅ 不会与 Midscene 的环境变量功能冲突
- ✅ 历史记录和模板保留原始变量语法

## 参考文档

- [变量功能使用说明](../../apps/web/README_VARIABLE_FEATURE.md)
- [Midscene YAML 文档](https://midscenejs.com/)
