# å¼€å‘è§„èŒƒ - å¿«é€Ÿå‚è€ƒ

> å®Œæ•´ç‰ˆè§„èŒƒè¯·æŸ¥çœ‹ï¼š[å¼€å‘è§„èŒƒ.md](./å¼€å‘è§„èŒƒ.md)

---

## ğŸ¯ æ ¸å¿ƒåŸåˆ™

1. **ä»£ç è´¨é‡ä¼˜å…ˆ**ï¼šä½¿ç”¨ Biome ä¿æŒä»£ç æ•´æ´
2. **ç±»å‹å®‰å…¨**ï¼šé¿å…ä½¿ç”¨ `any`ï¼Œå……åˆ†åˆ©ç”¨ TypeScript
3. **å•ä¸€èŒè´£**ï¼šæ¯ä¸ªå‡½æ•°/ç±»åªåšä¸€ä»¶äº‹
4. **DRY åŸåˆ™**ï¼šä¸è¦é‡å¤è‡ªå·±ï¼ˆDon't Repeat Yourselfï¼‰
5. **æµ‹è¯•é©±åŠ¨**ï¼šå…³é”®åŠŸèƒ½å¿…é¡»æœ‰æµ‹è¯•è¦†ç›–

---

## ğŸ“ ä»£ç é£æ ¼é€ŸæŸ¥

### æ ¼å¼åŒ–

```bash
# è‡ªåŠ¨æ ¼å¼åŒ–ä»£ç 
pnpm format

# æ£€æŸ¥ä»£ç è´¨é‡
pnpm check

# è‡ªåŠ¨ä¿®å¤é—®é¢˜
pnpm fix
```

### ä»£ç è§„åˆ™

- âœ… å•å¼•å· `'string'`
- âœ… 2 ç©ºæ ¼ç¼©è¿›
- âœ… è¡Œå®½ 80 å­—ç¬¦
- âœ… ä½¿ç”¨ LF æ¢è¡Œç¬¦

---

## ğŸ·ï¸ å‘½åé€ŸæŸ¥

| ç±»å‹ | è§„åˆ™ | ç¤ºä¾‹ |
|------|------|------|
| æ–‡ä»¶ | camelCase | `webOperateService.ts` |
| ç»„ä»¶ | PascalCase | `JsonPreview.tsx` |
| ç±» | PascalCase | `BaseOperateService` |
| æ¥å£ | PascalCase | `WebSocketMessage` |
| å‡½æ•° | camelCase | `handleWebSocketMessage()` |
| å˜é‡ | camelCase | `userName`, `isConnected` |
| å¸¸é‡ | UPPER_SNAKE_CASE | `MAX_RETRY_COUNT` |
| æšä¸¾ | PascalCase | `OperateServiceState` |
| æšä¸¾æˆå‘˜ | UPPER_CASE | `STOPPED`, `RUNNING` |

---

## ğŸ—ï¸ æ¶æ„é€ŸæŸ¥

### è®¾è®¡æ¨¡å¼

#### 1. å•ä¾‹æ¨¡å¼ï¼ˆService ç±»å¿…é¡»ï¼‰

```typescript
export class MyService {
  private static instance: MyService | null = null;

  private constructor() { }

  public static getInstance(): MyService {
    if (!MyService.instance) {
      MyService.instance = new MyService();
    }
    return MyService.instance;
  }
}
```

#### 2. å·¥å‚æ¨¡å¼ï¼ˆHandler åˆ›å»ºï¼‰

```typescript
export const handleExecute = createAiHandlerFactory(
  () => WebOperateServiceRefactored.getInstance(),
  'Web',
  { checkAndReconnect: true }
);
```

#### 3. æ¨¡æ¿æ–¹æ³•æ¨¡å¼ï¼ˆService ç»§æ‰¿ï¼‰

```typescript
export abstract class BaseOperateService<TAgent> {
  protected abstract createAgent(): Promise<void>;
  protected abstract initializeConnection(): Promise<void>;
}
```

---

## ğŸ“Š ç±»å‹å®šä¹‰é€ŸæŸ¥

### åŸºæœ¬åŸåˆ™

- âœ… ä¼˜å…ˆä½¿ç”¨ `interface` å®šä¹‰å¯¹è±¡
- âœ… ä½¿ç”¨ `type` å®šä¹‰è”åˆç±»å‹ã€äº¤å‰ç±»å‹
- âœ… é¿å… `any`ï¼Œå¿…é¡»ä½¿ç”¨æ—¶æ·»åŠ æ³¨é‡Š
- âœ… ä½¿ç”¨æ³›å‹å¢å¼ºå¤ç”¨æ€§

### ç¤ºä¾‹

```typescript
// Interface
export interface WebSocketMessage {
  meta: { messageId: string; };
  payload: { action: string; };
}

// Type Alias
export type ClientType = 'web' | 'windows';

// Generic
export class BaseService<TAgent extends AgentType> {
  public agent: TAgent | null = null;
}
```

---

## ğŸš¨ é”™è¯¯å¤„ç†é€ŸæŸ¥

```typescript
// 1. è‡ªå®šä¹‰é”™è¯¯ç±»
export class AppError extends Error {
  constructor(
    public message: string,
    public statusCode: number = 500,
  ) {
    super(message);
  }
}

// 2. Try-Catch-Finally
try {
  await operation();
} catch (error) {
  logger.error({ error }, 'æ“ä½œå¤±è´¥');
  throw new AppError('æ“ä½œå¤±è´¥', 500);
} finally {
  await cleanup();
}

// 3. WebSocket é”™è¯¯å“åº”
const errorResponse = createErrorResponse(
  message,
  error,
  'æ“ä½œå¤±è´¥'
);
send(errorResponse);
```

---

## ğŸ“ æ—¥å¿—é€ŸæŸ¥

### æ—¥å¿—çº§åˆ«

| çº§åˆ« | ä½¿ç”¨åœºæ™¯ |
|------|---------|
| `debug` | è°ƒè¯•ä¿¡æ¯ï¼ˆå¼€å‘ç¯å¢ƒï¼‰ |
| `info` | ä¸€èˆ¬ä¿¡æ¯ã€å…³é”®æ“ä½œ |
| `warn` | è­¦å‘Šã€æ½œåœ¨é—®é¢˜ |
| `error` | é”™è¯¯ä¿¡æ¯ |
| `fatal` | ä¸¥é‡é”™è¯¯ |

### ç»“æ„åŒ–æ—¥å¿—

```typescript
// âœ… å¥½çš„æ—¥å¿—
serviceLogger.info(
  {
    taskId,
    duration,
    params,
  },
  'ä»»åŠ¡æ‰§è¡ŒæˆåŠŸ'
);

// âŒ ä¸å¥½çš„æ—¥å¿—
logger.info('ä»»åŠ¡æˆåŠŸ');  // ç¼ºå°‘ä¸Šä¸‹æ–‡
```

### ä¸“ç”¨ Logger

```typescript
import {
  wsLogger,      // WebSocket
  serverLogger,  // æœåŠ¡å™¨
  serviceLogger, // æœåŠ¡
} from '@/utils/logger';
```

---

## ğŸ”Œ WebSocket é€ŸæŸ¥

### æ¶ˆæ¯ç»“æ„

```typescript
// å…¥ç«™ï¼ˆå®¢æˆ·ç«¯ -> æœåŠ¡ç«¯ï¼‰
interface WsInboundMessage {
  meta: {
    messageId: string;
    conversationId: string;
    timestamp: number;
    clientType?: 'web' | 'windows';
  };
  payload: {
    action: WebSocketAction;
    params: any;
  };
}

// å‡ºç«™ï¼ˆæœåŠ¡ç«¯ -> å®¢æˆ·ç«¯ï¼‰
interface WsOutboundMessage {
  meta: { messageId, conversationId, timestamp };
  payload: {
    action: WebSocketAction;
    status: 'success' | 'failed';
    result?: any;
    error?: string;
  };
}
```

### Handler æ¨¡æ¿

```typescript
export const handleAction: MessageHandler = async (
  { connectionId, send },
  message
) => {
  setLogContextFromMessage(message, connectionId);

  try {
    const result = await processAction(message.payload.params);
    send(createSuccessResponse(message, result));
  } catch (error) {
    send(createErrorResponse(message, error, 'æ“ä½œå¤±è´¥'));
  }
};
```

---

## ğŸ§ª æµ‹è¯•é€ŸæŸ¥

### æµ‹è¯•æ–‡ä»¶ä½ç½®

```
src/services/MyService.ts
src/services/__tests__/MyService.test.ts
```

### æµ‹è¯•å‘½ä»¤

```bash
pnpm test              # è¿è¡Œæ‰€æœ‰æµ‹è¯•
pnpm test:coverage     # æŸ¥çœ‹è¦†ç›–ç‡
pnpm test:ui           # æµ‹è¯• UI
pnpm test:watch        # ç›‘å¬æ¨¡å¼
```

### æµ‹è¯•æ¨¡æ¿

```typescript
describe('MyService', () => {
  let service: MyService;

  beforeEach(() => {
    service = MyService.getInstance();
  });

  afterEach(() => {
    MyService.resetInstance();
  });

  it('åº”è¯¥æ­£ç¡®åˆå§‹åŒ–', () => {
    expect(service.getState()).toBe('stopped');
  });
});
```

---

## ğŸ“š æ–‡æ¡£é€ŸæŸ¥

### ä½•æ—¶ç¼–å†™æ–‡æ¡£

âœ… **å¿…é¡»å†™**ï¼š

- å¤§å‹é‡æ„
- æ–°åŠŸèƒ½å¼€å‘
- é«˜ä»·å€¼é—®é¢˜ä¿®å¤
- æ€§èƒ½ä¼˜åŒ–

âŒ **ä¸éœ€è¦**ï¼š

- ç®€å• Bug ä¿®å¤
- ä»£ç æ ¼å¼è°ƒæ•´
- ä¾èµ–å‡çº§

### æ–‡æ¡£åˆ†ç±»

```
docs/
â”œâ”€â”€ åŠŸèƒ½å¼€å‘/
â”œâ”€â”€ æ¶æ„é‡æ„/
â”œâ”€â”€ é—®é¢˜ä¿®å¤/
â””â”€â”€ æ€§èƒ½ä¼˜åŒ–/
```

### æ–‡æ¡£å‘½å

- âœ… ä½¿ç”¨ä¸­æ–‡åç§°
- âœ… ç®€æ´æ˜äº†ï¼ˆ< 20 å­—ï¼‰
- âœ… åŒ…å«å…³é”®è¯

---

## ğŸ”„ Git æäº¤é€ŸæŸ¥

### æäº¤æ ¼å¼

```
<type>(<scope>): <subject>

<body>
```

### Type ç±»å‹

| Type | è¯´æ˜ | ç¤ºä¾‹ |
|------|------|------|
| `feat` | æ–°åŠŸèƒ½ | `feat(service): æ·»åŠ ç¼“å­˜æœºåˆ¶` |
| `fix` | Bug ä¿®å¤ | `fix(websocket): ä¿®å¤è¿æ¥é—®é¢˜` |
| `refactor` | é‡æ„ | `refactor(service): æå–åŸºç±»` |
| `docs` | æ–‡æ¡£ | `docs: æ›´æ–°å¼€å‘è§„èŒƒ` |
| `test` | æµ‹è¯• | `test: æ·»åŠ å•å…ƒæµ‹è¯•` |
| `chore` | æ„å»º/å·¥å…· | `chore: å‡çº§ä¾èµ–` |
| `perf` | æ€§èƒ½ | `perf: ä¼˜åŒ–æŸ¥è¯¢æ€§èƒ½` |

### ç¤ºä¾‹

```bash
git commit -m "feat(service): æ·»åŠ  BaseOperateService åŸºç±»"
git commit -m "fix(handler): ä¿®å¤æ¶ˆæ¯ ID ä¸åŒ¹é…é—®é¢˜"
git commit -m "refactor(websocket): ä½¿ç”¨å·¥å‚æ¨¡å¼"
```

---

## ğŸš€ Service å¼€å‘é€ŸæŸ¥

### Service ç±»æ¨¡æ¿

```typescript
export class MyService extends BaseOperateService<MyAgent> {
  private static instance: MyService | null = null;

  private constructor() {
    super();
  }

  public static getInstance(): MyService {
    if (!MyService.instance) {
      MyService.instance = new MyService();
    }
    return MyService.instance;
  }

  public static resetInstance(): void {
    MyService.instance = null;
  }

  protected async createAgent(): Promise<void> {
    // å®ç°
  }

  protected async initializeConnection(): Promise<void> {
    // å®ç°
  }

  protected getServiceName(): string {
    return 'MyService';
  }
}
```

---

## ğŸ“¦ Import é¡ºåº

```typescript
// 1. Node.js å†…ç½®
import { EventEmitter } from 'node:events';

// 2. ç¬¬ä¸‰æ–¹ä¾èµ–
import { Hono } from 'hono';

// 3. å†…éƒ¨æ¨¡å—ï¼ˆåˆ«åï¼‰
import type { WebSocketMessage } from '@/types';
import { logger } from '@/utils/logger';

// 4. ç›¸å¯¹è·¯å¾„
import { helper } from './helper';
```

---

## âš¡ æ€§èƒ½ä¼˜åŒ–é€ŸæŸ¥

```typescript
// âœ… å¹¶è¡Œæ‰§è¡Œ
const [r1, r2, r3] = await Promise.all([
  fetch1(),
  fetch2(),
  fetch3(),
]);

// âœ… ç¼“å­˜æœºåˆ¶
private cache = new Map<string, any>();

// âœ… èµ„æºæ¸…ç†
try {
  await operation();
} finally {
  await cleanup();
}

// âœ… æ€§èƒ½ç›‘æ§
const start = performance.now();
await operation();
const duration = performance.now() - start;
logger.info({ duration }, 'æ“ä½œå®Œæˆ');
```

---

## ğŸ”’ å®‰å…¨é€ŸæŸ¥

```typescript
// âœ… ç¯å¢ƒå˜é‡
const apiKey = process.env.API_KEY;

// âœ… è¾“å…¥éªŒè¯
if (typeof input !== 'string') {
  throw new AppError('Invalid input', 400);
}

// âœ… æ—¥å¿—è„±æ•
function sanitize(data: any) {
  return {
    ...data,
    password: '***',
    token: '***',
  };
}
```

---

## ğŸ“‹ å¸¸ç”¨å‘½ä»¤

```bash
# å¼€å‘
pnpm dev
pnpm --filter @midscene/server dev

# æ„å»º
pnpm build
pnpm build:prod
pnpm build:staging

# æµ‹è¯•
pnpm test
pnpm test:coverage
pnpm test:ui

# ä»£ç è´¨é‡
pnpm lint
pnpm format
pnpm check
pnpm fix
```

---

## ğŸ“– ç›¸å…³æ–‡æ¡£

- [å®Œæ•´å¼€å‘è§„èŒƒ](./å¼€å‘è§„èŒƒ.md)
- [æœåŠ¡å±‚é‡æ„æ–¹æ¡ˆ](./æ¶æ„é‡æ„/æœåŠ¡å±‚é‡æ„æ–¹æ¡ˆ.md)
- [ä»£ç å¯¹æ¯”ä¸è¿ç§»æŒ‡å—](./æ¶æ„é‡æ„/ä»£ç å¯¹æ¯”ä¸è¿ç§»æŒ‡å—.md)
- [WebSocket ä¼ å€¼è¯´æ˜](./WebSocketä¼ å€¼è¯´æ˜.md)
- [Monorepo ä½¿ç”¨æŒ‡å—](./Monorepoä½¿ç”¨æŒ‡å—.md)

---

**æç¤º**ï¼šæœ¬æ–‡æ¡£æ˜¯å¿«é€Ÿå‚è€ƒç‰ˆæœ¬ï¼Œè¯¦ç»†è§„èŒƒè¯·æŸ¥çœ‹å®Œæ•´ç‰ˆæ–‡æ¡£ã€‚
